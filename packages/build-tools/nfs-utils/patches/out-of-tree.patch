commit ca48ceaabe2932d1180e6928695e86f8a57feb2b
Author: Thierry Reding <treding@nvidia.com>
Date:   Tue Nov 29 14:17:36 2022 +0100

    out-of-tree

diff --git a/support/export/Makefile.am b/support/export/Makefile.am
index eec737f66149..8c12ec006738 100644
--- a/support/export/Makefile.am
+++ b/support/export/Makefile.am
@@ -9,6 +9,8 @@ GENFILES	= $(GENFILES_CLNT) $(GENFILES_SVC) $(GENFILES_XDR) $(GENFILES_H)
 
 EXTRA_DIST	= mount.x
 
+AM_CFLAGS = -I$(top_srcdir)/support/include $(TIRPC_CFLAGS)
+
 noinst_LIBRARIES = libexport.a
 libexport_a_SOURCES = client.c export.c hostname.c \
 		      xtab.c mount_clnt.c mount_xdr.c \
@@ -26,7 +28,7 @@ dist-hook:
 if CONFIG_RPCGEN
 RPCGEN		= $(top_builddir)/tools/rpcgen/rpcgen
 $(RPCGEN):
-	make -C $(top_srcdir)/tools/rpcgen all
+	make -C ../../tools/rpcgen all
 else
 RPCGEN = @RPCGEN_PATH@
 endif
diff --git a/support/misc/Makefile.am b/support/misc/Makefile.am
index f9993e3ac897..3757fea643e3 100644
--- a/support/misc/Makefile.am
+++ b/support/misc/Makefile.am
@@ -1,5 +1,7 @@
 ## Process this file with automake to produce Makefile.in
 
+AM_CFLAGS = -I$(top_srcdir)/support/include $(TIRPC_CFLAGS)
+
 noinst_LIBRARIES = libmisc.a
 libmisc_a_SOURCES = tcpwrapper.c from_local.c mountpoint.c file.c \
 		    nfsd_path.c workqueue.c xstat.c
diff --git a/support/nfs/Makefile.am b/support/nfs/Makefile.am
index 67e3a8e134c8..b448d2abbfec 100644
--- a/support/nfs/Makefile.am
+++ b/support/nfs/Makefile.am
@@ -1,5 +1,7 @@
 ## Process this file with automake to produce Makefile.in
 
+AM_CFLAGS = -I$(top_srcdir)/support/include
+
 noinst_LIBRARIES = 
 noinst_LTLIBRARIES = libnfs.la libnfsconf.la
 
diff --git a/support/nfsidmap/Makefile.am b/support/nfsidmap/Makefile.am
index f5b9de0e1e91..a8ab83d03662 100644
--- a/support/nfsidmap/Makefile.am
+++ b/support/nfsidmap/Makefile.am
@@ -17,6 +17,9 @@ endif
 if ENABLE_LDAP_SASL
 KRB5_GSS_LIB=-lgssapi_krb5
 endif
+
+AM_CFLAGS = -I$(top_srcdir)/support/include
+
 lib_LTLIBRARIES = libnfsidmap.la
 pkgplugin_LTLIBRARIES = nsswitch.la static.la regex.la $(UMICH_LDAP_LIB) $(GUMS_MAPPING_LIB)
 
diff --git a/support/nsm/Makefile.am b/support/nsm/Makefile.am
index 8f5874ef26b8..e74121b1bbd9 100644
--- a/support/nsm/Makefile.am
+++ b/support/nsm/Makefile.am
@@ -9,6 +9,8 @@ GENFILES	= $(GENFILES_CLNT) $(GENFILES_SVC) $(GENFILES_XDR) $(GENFILES_H)
 
 EXTRA_DIST	= sm_inter.x
 
+AM_CFLAGS = -I$(top_srcdir)/support/include
+
 noinst_LIBRARIES = libnsm.a
 libnsm_a_SOURCES = $(GENFILES) file.c rpc.c
 
diff --git a/systemd/Makefile.am b/systemd/Makefile.am
index 7b5ab84bd793..cc8b36a2ed56 100644
--- a/systemd/Makefile.am
+++ b/systemd/Makefile.am
@@ -2,7 +2,7 @@
 
 MAINTAINERCLEANFILES = Makefile.in
 
-modprobe_files = 50-nfs.conf
+modprobe_files = $(srcdir)/50-nfs.conf
 
 unit_files =  \
     nfs-client.target \
diff --git a/tools/mountstats/Makefile.am b/tools/mountstats/Makefile.am
index c2e9f9995ada..86ae4398d73f 100644
--- a/tools/mountstats/Makefile.am
+++ b/tools/mountstats/Makefile.am
@@ -8,6 +8,6 @@ EXTRA_DIST	= $(man8_MANS) $(PYTHON_FILES)
 all-local: $(PYTHON_FILES)
 
 install-data-hook:
-	$(INSTALL) -m 755 mountstats.py $(DESTDIR)$(sbindir)/mountstats
+	$(INSTALL) -m 755 $(srcdir)/mountstats.py $(DESTDIR)$(sbindir)/mountstats
 
 MAINTAINERCLEANFILES=Makefile.in
diff --git a/tools/nfs-iostat/Makefile.am b/tools/nfs-iostat/Makefile.am
index 3ae0f29701ca..c939d7e14d76 100644
--- a/tools/nfs-iostat/Makefile.am
+++ b/tools/nfs-iostat/Makefile.am
@@ -8,6 +8,6 @@ EXTRA_DIST	= $(man8_MANS) $(PYTHON_FILES)
 all-local: $(PYTHON_FILES)
 
 install-data-hook:
-	$(INSTALL) -m 755 nfs-iostat.py $(DESTDIR)$(sbindir)/nfsiostat
+	$(INSTALL) -m 755 $(srcdir)/nfs-iostat.py $(DESTDIR)$(sbindir)/nfsiostat
 
 MAINTAINERCLEANFILES=Makefile.in
diff --git a/tools/nfsconf/Makefile.am b/tools/nfsconf/Makefile.am
index b3c1495f83cd..391df314b930 100644
--- a/tools/nfsconf/Makefile.am
+++ b/tools/nfsconf/Makefile.am
@@ -3,6 +3,8 @@
 man8_MANS	= nfsconf.man
 EXTRA_DIST	= $(man8_MANS)
 
+AM_CFLAGS = -I$(top_srcdir)/support/include
+
 sbin_PROGRAMS = nfsconf
 
 nfsconf_SOURCES = nfsconfcli.c
diff --git a/tools/nfsdclddb/Makefile.am b/tools/nfsdclddb/Makefile.am
index 18263fb2be7f..39538755c6c3 100644
--- a/tools/nfsdclddb/Makefile.am
+++ b/tools/nfsdclddb/Makefile.am
@@ -8,6 +8,6 @@ EXTRA_DIST	= $(man8_MANS) $(PYTHON_FILES)
 all-local: $(PYTHON_FILES)
 
 install-data-hook:
-	$(INSTALL) -m 755 nfsdclddb.py $(DESTDIR)$(sbindir)/nfsdclddb
+	$(INSTALL) -m 755 $(srcdir)/nfsdclddb.py $(DESTDIR)$(sbindir)/nfsdclddb
 
 MAINTAINERCLEANFILES=Makefile.in
diff --git a/tools/nfsdclnts/Makefile.am b/tools/nfsdclnts/Makefile.am
index d513edb27c8f..ff49a230cbd3 100644
--- a/tools/nfsdclnts/Makefile.am
+++ b/tools/nfsdclnts/Makefile.am
@@ -8,6 +8,6 @@ EXTRA_DIST      = $(man8_MANS) $(PYTHON_FILES)
 all-local: $(PYTHON_FILES)
 
 install-data-hook:
-	$(INSTALL) -m 755 nfsdclnts.py $(DESTDIR)$(sbindir)/nfsdclnts
+	$(INSTALL) -m 755 $(srcdir)/nfsdclnts.py $(DESTDIR)$(sbindir)/nfsdclnts
 
 MAINTAINERCLEANFILES=Makefile.in
diff --git a/tools/nfsrahead/Makefile.am b/tools/nfsrahead/Makefile.am
index 845ea0d576b4..b0512179ce01 100644
--- a/tools/nfsrahead/Makefile.am
+++ b/tools/nfsrahead/Makefile.am
@@ -1,3 +1,5 @@
+AM_CFLAGS = -I$(top_srcdir)/support/include
+
 libexec_PROGRAMS = nfsrahead
 nfsrahead_SOURCES = main.c
 nfsrahead_LDFLAGS= -lmount
diff --git a/tools/rpcctl/Makefile.am b/tools/rpcctl/Makefile.am
index 33fb431fe7d4..bb70d6fe4dc0 100644
--- a/tools/rpcctl/Makefile.am
+++ b/tools/rpcctl/Makefile.am
@@ -8,6 +8,6 @@ EXTRA_DIST = $(man8_MANS) $(PYTHON_FILES)
 all-local: $(PYTHON_FILES)
 
 install-data-hook:
-	$(INSTALL) -m 755 rpcctl.py $(DESTDIR)$(sbindir)/rpcctl
+	$(INSTALL) -m 755 $(srcdir)/rpcctl.py $(DESTDIR)$(sbindir)/rpcctl
 
 MAINTAINERCLEANFILES=Makefile.in
diff --git a/tools/rpcdebug/Makefile.am b/tools/rpcdebug/Makefile.am
index b0a3e1f9fe1a..e620ec912d0b 100644
--- a/tools/rpcdebug/Makefile.am
+++ b/tools/rpcdebug/Makefile.am
@@ -3,6 +3,8 @@
 man8_MANS = rpcdebug.man
 EXTRA_DIST = $(man8_MANS)
 
+AM_CFLAGS = -I$(top_srcdir)/support/include
+
 sbin_PROGRAMS = rpcdebug
 rpcdebug_SOURCES = rpcdebug.c
 
diff --git a/tools/rpcgen/Makefile.am b/tools/rpcgen/Makefile.am
index 457cd5074a1b..cf345b88e555 100644
--- a/tools/rpcgen/Makefile.am
+++ b/tools/rpcgen/Makefile.am
@@ -10,4 +10,5 @@ noinst_HEADERS = proto.h rpc_parse.h rpc_scan.h rpc_util.h
 rpcgen_SOURCES = rpc_clntout.c rpc_cout.c rpc_hout.c rpc_main.c \
 	rpc_parse.c rpc_sample.c rpc_scan.c rpc_svcout.c rpc_tblout.c \
 	rpc_util.c
+rpcgen_CPPFLAGS = -I$(top_srcdir)/support/include
 rpcgen_LDADD = $(LIBINTL)
diff --git a/tools/rpcgen/rpc_main.c b/tools/rpcgen/rpc_main.c
index 277adc6bc363..70b88777f2ca 100644
--- a/tools/rpcgen/rpc_main.c
+++ b/tools/rpcgen/rpc_main.c
@@ -486,7 +486,7 @@ c_output (const char *infile, const char *define, int extend,
   add_warning ();
   if (infile && (include = extendfile (infile, ".h")))
     {
-      fprintf (fout, "#include \"%s\"\n", include);
+      fprintf (fout, "#include \"%s\"\n", basename(include));
       free (include);
       /* .h file already contains rpc/rpc.h */
     }
@@ -688,7 +688,7 @@ s_output (int argc, const char *argv[], const char *infile, const char *define,
   add_warning ();
   if (infile && (include = extendfile (infile, ".h")))
     {
-      fprintf (fout, "#include \"%s\"\n", include);
+      fprintf (fout, "#include \"%s\"\n", basename(include));
       free (include);
     }
   else
@@ -789,7 +789,7 @@ l_output (const char *infile, const char *define, int extend,
     fprintf (fout, "#include <memory.h> /* for memset */\n");
   if (infile && (include = extendfile (infile, ".h")))
     {
-      fprintf (fout, "#include \"%s\"\n", include);
+      fprintf (fout, "#include \"%s\"\n", basename(include));
       free (include);
     }
   else
diff --git a/utils/blkmapd/Makefile.am b/utils/blkmapd/Makefile.am
index 56c8a4bb4ee2..6bd743f1ad7c 100644
--- a/utils/blkmapd/Makefile.am
+++ b/utils/blkmapd/Makefile.am
@@ -3,7 +3,7 @@
 man8_MANS	= blkmapd.man
 EXTRA_DIST = $(man8_MANS)
 
-AM_CFLAGS	+= -D_LARGEFILE64_SOURCE
+AM_CFLAGS	+= -D_LARGEFILE64_SOURCE -I$(top_srcdir)/support/include
 sbin_PROGRAMS	= blkmapd
 
 blkmapd_SOURCES = \
diff --git a/utils/exportfs/Makefile.am b/utils/exportfs/Makefile.am
index 96524c729359..0abe1eb52e2d 100644
--- a/utils/exportfs/Makefile.am
+++ b/utils/exportfs/Makefile.am
@@ -4,6 +4,8 @@ man5_MANS	= exports.man
 man7_MANS	= nfsd.man
 man8_MANS	= exportfs.man
 
+AM_CFLAGS = -I$(top_srcdir)/support/include
+
 EXTRA_DIST	= $(man5_MANS) $(man7_MANS) $(man8_MANS)
 sbin_PROGRAMS	= exportfs
 exportfs_SOURCES = exportfs.c
diff --git a/utils/gssd/Makefile.am b/utils/gssd/Makefile.am
index 21d3bb8888b8..bc4955b2b76e 100644
--- a/utils/gssd/Makefile.am
+++ b/utils/gssd/Makefile.am
@@ -5,7 +5,7 @@ if CONFIG_SVCGSS
 man8_MANS	+= svcgssd.man
 endif
 
-AM_CPPFLAGS += -I ../../support/nfsidmap
+AM_CFLAGS = -I$(top_srcdir)/support/include -I$(top_srcdir)/support/nfsidmap
 
 RPCPREFIX	= rpc.
 KPREFIX		= @kprefix@
diff --git a/utils/idmapd/Makefile.am b/utils/idmapd/Makefile.am
index e09e8c53821d..dd3f454901d8 100644
--- a/utils/idmapd/Makefile.am
+++ b/utils/idmapd/Makefile.am
@@ -2,7 +2,7 @@
 
 man8_MANS	= idmapd.man
 
-AM_CPPFLAGS += -I ../../support/nfsidmap
+AM_CFLAGS = -I$(top_srcdir)/support/include -I$(top_srcdir)/support/nfsidmap
 
 RPCPREFIX	= rpc.
 KPREFIX		= @kprefix@
diff --git a/utils/mount/Makefile.am b/utils/mount/Makefile.am
index 3101f7abd7f4..88aefc3815a8 100644
--- a/utils/mount/Makefile.am
+++ b/utils/mount/Makefile.am
@@ -9,6 +9,8 @@
 man8_MANS	= mount.nfs.man umount.nfs.man
 man5_MANS	= nfs.man
 
+AM_CFLAGS = -I$(top_srcdir)/support/include
+
 sbin_PROGRAMS	= mount.nfs
 EXTRA_DIST = nfsmount.conf $(man8_MANS) $(man5_MANS)
 mount_common = error.c network.c token.c \
diff --git a/utils/mountd/Makefile.am b/utils/mountd/Makefile.am
index 13b25c90f06e..3151d89fd46d 100644
--- a/utils/mountd/Makefile.am
+++ b/utils/mountd/Makefile.am
@@ -8,6 +8,8 @@ endif
 man8_MANS	= mountd.man
 EXTRA_DIST	= $(man8_MANS)
 
+AM_CFLAGS = -I$(top_srcdir)/support/include
+
 RPCPREFIX	= rpc.
 KPREFIX		= @kprefix@
 sbin_PROGRAMS	= mountd
diff --git a/utils/nfsd/Makefile.am b/utils/nfsd/Makefile.am
index 8acc9a04a8c0..51925839b9e5 100644
--- a/utils/nfsd/Makefile.am
+++ b/utils/nfsd/Makefile.am
@@ -3,6 +3,8 @@
 man8_MANS	= nfsd.man
 EXTRA_DIST	= $(man8_MANS)
 
+AM_CFLAGS = -I$(top_srcdir)/support/include
+
 RPCPREFIX	= rpc.
 KPREFIX		= @kprefix@
 sbin_PROGRAMS	= nfsd
diff --git a/utils/nfsdcld/Makefile.am b/utils/nfsdcld/Makefile.am
index 273d64f1c5f0..8c49effc5072 100644
--- a/utils/nfsdcld/Makefile.am
+++ b/utils/nfsdcld/Makefile.am
@@ -3,7 +3,7 @@
 man8_MANS	= nfsdcld.man
 EXTRA_DIST	= $(man8_MANS)
 
-AM_CFLAGS	+= -D_LARGEFILE64_SOURCE
+AM_CFLAGS	+= -D_LARGEFILE64_SOURCE -I$(top_srcdir)/support/include
 sbin_PROGRAMS	= nfsdcld
 
 nfsdcld_SOURCES = nfsdcld.c sqlite.c legacy.c
diff --git a/utils/nfsdcltrack/Makefile.am b/utils/nfsdcltrack/Makefile.am
index 769e4a455fcf..941236fb8132 100644
--- a/utils/nfsdcltrack/Makefile.am
+++ b/utils/nfsdcltrack/Makefile.am
@@ -10,7 +10,7 @@
 man8_MANS	= nfsdcltrack.man
 EXTRA_DIST	= $(man8_MANS)
 
-AM_CFLAGS	+= -D_LARGEFILE64_SOURCE
+AM_CFLAGS	+= -D_LARGEFILE64_SOURCE -I$(top_srcdir)/support/include
 sbin_PROGRAMS	= nfsdcltrack
 
 noinst_HEADERS	= sqlite.h
diff --git a/utils/nfsidmap/Makefile.am b/utils/nfsidmap/Makefile.am
index e5d7d04c1799..ed81794b5bac 100644
--- a/utils/nfsidmap/Makefile.am
+++ b/utils/nfsidmap/Makefile.am
@@ -3,7 +3,7 @@
 man8_MANS = nfsidmap.man
 sbin_PROGRAMS	= nfsidmap
 
-AM_CPPFLAGS += -I ../../support/nfsidmap
+AM_CFLAGS = -I$(top_srcdir)/support/include -I$(top_srcdir)/support/nfsidmap
 
 nfsidmap_SOURCES = nfsidmap.c
 nfsidmap_LDADD = -lkeyutils \
diff --git a/utils/showmount/Makefile.am b/utils/showmount/Makefile.am
index d0a16b2b048a..482fe1a33ca8 100644
--- a/utils/showmount/Makefile.am
+++ b/utils/showmount/Makefile.am
@@ -3,6 +3,8 @@
 man8_MANS	= showmount.man
 EXTRA_DIST	= $(man8_MANS)
 
+AM_CFLAGS = -I$(top_srcdir)/support/include
+
 sbin_PROGRAMS	= showmount
 showmount_SOURCES = showmount.c
 showmount_LDADD = ../../support/export/libexport.a \
diff --git a/utils/statd/Makefile.am b/utils/statd/Makefile.am
index 6facc15d856c..8ab8d8222a8a 100644
--- a/utils/statd/Makefile.am
+++ b/utils/statd/Makefile.am
@@ -2,6 +2,8 @@
 
 man8_MANS = statd.man sm-notify.man
 
+AM_CFLAGS = -I$(top_srcdir)/support/include
+
 RPCPREFIX	= rpc.
 KPREFIX		= @kprefix@
 sbin_PROGRAMS	= statd sm-notify
